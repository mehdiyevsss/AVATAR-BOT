<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Voice Avatar Chatbot</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
      font-family: "Segoe UI", sans-serif;
      background: #574e4e;
      color: #2D3439;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      display: flex;
      height: 90vh;
      width: 90vw;
      max-width: 1400px;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(225, 228, 232, 0.5);
      overflow: hidden;
    }

    model-viewer {
      flex: 1 1 0;
      height: 100%;
      background: 
    url('/static/Swisscom.jpg')   /* path to your JPEG */
    center center            /* position */
    / cover no-repeat;  
      background-color: #000;
    } 

    .chat-section {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      padding: 20px;
      background: #f5f5f5;
      height: 100%;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      padding-right: 10px;
      display: flex;
      flex-direction: column;
    }

    .message {
      margin-bottom: 10px;
      padding: 14px 18px;
      border-radius: 14px;
      font-size: 15px;
      max-width: 100%;
      background: #e0e0e0;
      color: #000;
    }

    .assistant {
      align-self: flex-start;
      background-color: #dbe4ff;
    }

    .user {
      align-self: flex-end;
      background-color: #ffe2e2;
    }

    .system {
      align-self: center;
      background-color: #fff3cd;
      color: #856404;
      text-align: center;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .record-btn,
    .human-btn,
    .video-btn {
      padding: 14px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
      min-width: 120px;
    }

    .record-btn {
      background: #333;
      color: white;
    }

    .human-btn {
      background: #28a745;
      color: white;
    }

    .video-btn {
      background: #007bff;
      color: white;
    }

    .record-btn:disabled,
    .human-btn:disabled,
    .video-btn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .spinner {
      width: 16px;
      height: 16px;
      margin-left: 10px;
      border: 2px solid white;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .video-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .video-container.active {
      display: flex;
    }

    .video-grid {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .video-box {
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .local-video {
      width: 300px;
      height: 225px;
    }

    .remote-video {
      width: 600px;
      height: 450px;
    }

    .video-box video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-label {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
    }

    .video-controls {
      display: flex;
      gap: 10px;
    }

    .video-controls button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .end-call {
      background: #dc3545;
      color: white;
    }

    .toggle-video,
    .toggle-audio {
      background: #6c757d;
      color: white;
    }

    .connection-status {
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }

    .connecting {
      background: #fff3cd;
      color: #856404;
    }

    .connected {
      background: #d4edda;
      color: #155724;
    }

    .disconnected {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>

<body>
  <div class="container">
    <model-viewer
      id="avatar"
      field-of-view="10deg"
      animation-name="Wave"
      nimation-crossfade-duration="0.5"

      src="static/avatar2.glb"
      
      style="--poster-color: transparent;">
    </model-viewer>


    <div class="chat-section">
      <div class="messages" id="messages"></div>
      <div class="controls">
        <button id="recordBtn" class="record-btn">üéôÔ∏è Record</button>
        <button id="humanBtn" class="human-btn" style="display: none;">üë• Connect to Human</button>
      </div>
    </div>
  </div>

  <!-- Video Call Container (unchanged) -->
  <div class="video-container" id="videoContainer">
    <div class="connection-status" id="connectionStatus">Connecting to operator...</div>
    <div class="video-grid">
      <div class="video-box local-video">
        <video id="localVideo" autoplay muted></video>
        <div class="video-label">You</div>
      </div>
      <div class="video-box remote-video">
        <video id="remoteVideo" autoplay></video>
        <div class="video-label">Operator</div>
      </div>
    </div>
    <div class="video-controls">
      <button id="toggleVideo" class="toggle-video">üìπ Video On</button>
      <button id="toggleAudio" class="toggle-audio">üé§ Audio On</button>
      <button id="endCall" class="end-call">üìû End Call</button>
    </div>
  </div>
 
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script>
    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const messagesEl = document.getElementById("messages");

    let currentAudio = null;
    let mediaRecorder;
    let listening = false;

    async function startListening() {
      if (listening) return;
      listening = true;
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const audioCtx = new AudioContext();
      const micSource = audioCtx.createMediaStreamSource(stream);
      const analyser = audioCtx.createAnalyser();
      micSource.connect(analyser);
      const data = new Uint8Array(analyser.fftSize);

      mediaRecorder = new MediaRecorder(stream);
      let audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: "audio/mp3" });
        processRecording(blob).then(() => {
          listening = false;
          startListening();  // Restart automatically
        });
      };

      audioChunks = [];
      mediaRecorder.start();
      detectSilence(analyser, data);
      addMessage("system", "üé§ Listening...");
    }

    function detectSilence(analyser, data, timeout = 1200, threshold = 10) {
      let lastSound = Date.now();
      (function loop() {
        analyser.getByteTimeDomainData(data);
        const silent = data.every(v => Math.abs(v - 128) < threshold);
        if (!silent) lastSound = Date.now();
        if (Date.now() - lastSound > timeout && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        } else if (mediaRecorder.state === "recording") {
          requestAnimationFrame(loop);
        }
      })();
    }

    async function processRecording(blob) {
      const formData = new FormData();
      formData.append("audio", blob, "voice.mp3");

      const trans = await fetch("/transcribe", { method: "POST", body: formData })
        .then(r => r.json()).catch(() => null);

      if (!trans || !trans.transcript) {
        addMessage("system", "‚ö†Ô∏è No transcription received.");
        return;
      }

      addMessage("user", trans.transcript);

      const respForm = new FormData();
      respForm.append("text", trans.transcript);
      const resp = await fetch("/respond", { method: "POST", body: respForm })
        .then(r => r.json()).catch(() => null);

      if (!resp || !resp.response) {
        addMessage("system", "‚ö†Ô∏è Bot failed to respond.");
        return;
      }

      addMessage("assistant", resp.response);

      if (currentAudio) currentAudio.pause();
      currentAudio = new Audio(resp.audio_url);
      return new Promise(resolve => {
        currentAudio.addEventListener("ended", resolve);
        currentAudio.play();
      });
    }

    function addMessage(role, text) {
      const div = document.createElement("div");
      div.className = `message ${role}`;
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Start Listening on Button
    recordBtn.onclick = () => {
      startListening();
    };

    // Stop Listening
    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        listening = false;
        addMessage("system", "üõë Listening stopped.");
      }
    };

    // Optionally auto-start on load
    // window.onload = () => startListening();
  </script>
  </script>
</body>
</html>
